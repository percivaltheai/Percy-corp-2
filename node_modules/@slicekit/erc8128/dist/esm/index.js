class J extends Error{code;constructor(R,f){super(f);this.code=R;this.name="Erc8128Error"}}import{sha256 as cf}from"@noble/hashes/sha2";var w="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",nf=(()=>{let R=new Uint8Array(256);R.fill(255);for(let f=0;f<w.length;f++)R[w.charCodeAt(f)]=f;return R[45]=62,R[95]=63,R})();function Df(R,f){if(R instanceof Request)return f?new Request(R,f):R;return new Request(R,f)}function l(R){return typeof R==="object"&&R!==null&&typeof R.signMessage==="function"}function L(R){try{return new URL(R)}catch{throw new J("UNSUPPORTED_REQUEST",`Request.url must be absolute (got: ${R}).`)}}function p(){return Math.floor(Date.now()/1000)}function jf(R){return new TextEncoder().encode(R)}function Mf(R){let f=globalThis.crypto;if(!f?.getRandomValues)throw new J("CRYPTO_UNAVAILABLE","crypto.getRandomValues required.");let I=new Uint8Array(R);return f.getRandomValues(I),I}async function r(R){try{let I=await R.clone().arrayBuffer();return new Uint8Array(I)}catch{throw new J("BODY_READ_FAILED","Failed to read request body (stream locked/disturbed).")}}async function s(R){return cf(R)}function A(R){let f="",I=0;for(;I+2<R.length;I+=3){let $=R[I]<<16|R[I+1]<<8|R[I+2];f+=w[$>>18&63]+w[$>>12&63]+w[$>>6&63]+w[$&63]}if(I===R.length)return f;let K=R[I]<<16;if(I+1<R.length){let $=K|R[I+1]<<8;f+=w[$>>18&63]+w[$>>12&63]+w[$>>6&63]+"="}else f+=`${w[K>>18&63]+w[K>>12&63]}==`;return f}function Qf(R){try{let f=R.trim().replace(/=+$/g,"");if(f.length===0)return new Uint8Array(0);if(f.length%4===1)return null;let I=new Uint8Array(Math.floor(f.length*3/4)),K=0,$=0,C=0;for(let Y=0;Y<f.length;Y++){let Z=nf[f.charCodeAt(Y)];if(Z===255)return null;if(K=K<<6|Z,$+=6,$>=8)$-=8,I[C++]=K>>$&255}return C===I.length?I:I.slice(0,C)}catch{return null}}function Wf(R){return A(R).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function wf(R){let f=R.slice(2);if(f.length%2!==0)throw new J("UNSUPPORTED_REQUEST","Invalid hex length.");let I=new Uint8Array(f.length/2);for(let K=0;K<I.length;K++)I[K]=parseInt(f.slice(K*2,K*2+2),16);return I}function a(R){let f="0x";for(let I of R)f+=I.toString(16).padStart(2,"0");return f}async function e(R,f){let I=new Headers(R.headers),K=I.get("content-digest");if(f==="off")throw new J("DIGEST_REQUIRED","content-digest is required by covered components, but contentDigest='off'.");if(f==="require"&&!K)throw new J("DIGEST_REQUIRED","content-digest is required but missing.");if(K&&f==="auto")return R;let $=await r(R),C=await s($),Y=A(C);return I.set("content-digest",`sha-256=:${Y}:`),new Request(R,{headers:I})}async function Ff(R){let f=R.headers.get("content-digest");if(!f)return!1;let I=df(f);if(!I)return!1;if(I.alg!=="sha-256")return!1;let K=await r(R),$=await s(K),C=A($);return tf(I.b64,C)}function df(R){let f=R.trim(),I=/^([A-Za-z0-9_-]+)=:([A-Za-z0-9+/]+={0,2}):$/.exec(f);if(!I)return null;return{alg:I[1].toLowerCase(),b64:I[2]}}function tf(R,f){if(R.length!==f.length)return!1;let I=0;for(let K=0;K<R.length;K++)I|=R.charCodeAt(K)^f.charCodeAt(K);return I===0}function Tf(R){let f=[];for(let I of _f(R)){let K=I.trim();if(!K)continue;let $=K.indexOf("=");if($<=0)throw new J("PARSE_ERROR","Invalid Signature-Input member (missing '=').");let C=K.slice(0,$).trim();B(C);let Y=K.slice($+1).trim(),Z=Y,G=lf(Y);f.push({label:C,components:G.items,params:G.params,signatureParamsValue:Z})}return f}function kf(R){let f=new Map;for(let I of _f(R)){let K=I.trim();if(!K)continue;let $=K.indexOf("=");if($<=0)throw new J("PARSE_ERROR","Invalid Signature member (missing '=').");let C=K.slice(0,$).trim();B(C);let Y=K.slice($+1).trim(),Z=of(Y);f.set(C,Z)}return f}function of(R){let f=R.trim();if(!f.startsWith(":")||!f.endsWith(":")||f.length<3)throw new J("PARSE_ERROR","Invalid sf-binary.");let I=f.slice(1,-1);if(!/^[A-Za-z0-9+/]+={0,2}$/.test(I))throw new J("PARSE_ERROR","Invalid base64 in sf-binary.");return I}function lf(R){let f=0,I=R.trim();if(I[f]!=="(")throw new J("PARSE_ERROR","Inner list must start with '('.");f++;let K=[];while(f<I.length){if(z(),I[f]===")"){f++;break}let X=Q();K.push(X),z()}if(K.length===0)throw new J("PARSE_ERROR","Inner list has no items.");let $={};while(f<I.length){if(z(),I[f]!==";")break;f++,z();let X=k();if(z(),I[f]!=="=")throw new J("PARSE_ERROR",`Param ${X} missing '='.`);f++,z();let D=W();$[X]=D}let{created:C,expires:Y,keyid:Z,nonce:G,tag:N}=$;if(!Number.isInteger(C)||!Number.isInteger(Y)||typeof Z!=="string")throw new J("PARSE_ERROR","Missing or invalid created/expires/keyid in Signature-Input.");let V={created:C,expires:Y,keyid:Z,...typeof G==="string"?{nonce:G}:{},...typeof N==="string"?{tag:N}:{}};return{items:K,params:V};function z(){while(f<I.length&&(I[f]===" "||I[f]==="\t"))f++}function Q(){if(I[f]!=='"')throw new J("PARSE_ERROR","Expected sf-string.");f++;let X="";while(f<I.length){let D=I[f];if(D==='"'){f++;break}if(D==="\\"){if(f++,f>=I.length)throw new J("PARSE_ERROR","Bad escape in sf-string.");X+=I[f],f++;continue}let _=D.charCodeAt(0);if(_<32||_===127)throw new J("PARSE_ERROR","Control char in sf-string.");X+=D,f++}return X}function k(){let X=f;while(f<I.length&&/[A-Za-z0-9_\-*.]/.test(I[f]))f++;if(f===X)throw new J("PARSE_ERROR","Expected token.");return I.slice(X,f)}function W(){if(I[f]==='"')return Q();let X=f;if(I[f]==="-")f++;while(f<I.length&&/[0-9]/.test(I[f]))f++;if(f===X)throw new J("PARSE_ERROR","Expected param value.");let D=Number(I.slice(X,f));if(!Number.isFinite(D))throw new J("PARSE_ERROR","Bad integer param value.");return D}}function _f(R){let f=[],I="",K=!1,$=!1;for(let C=0;C<R.length;C++){let Y=R[C];if($){I+=Y,$=!1;continue}if(Y==="\\"&&K){I+=Y,$=!0;continue}if(Y==='"'){I+=Y,K=!K;continue}if(Y===","&&!K){f.push(I),I="";continue}I+=Y}if(I)f.push(I);return f}function B(R){if(!/^[a-z][a-z0-9_.-]*$/.test(R))throw new J("PARSE_ERROR",`Invalid signature label: ${R}`)}function Hf(R,f){let $=`(${R.map((C)=>T(C)).join(" ")})`;if($+=`;created=${f.created}`,$+=`;expires=${f.expires}`,f.nonce!=null)$+=`;nonce=${T(f.nonce)}`;if(f.tag!=null)$+=`;tag=${T(f.tag)}`;return $+=`;keyid=${T(f.keyid)}`,$}function xf(R){if(!Number.isInteger(R.created)||!Number.isInteger(R.expires))throw new J("INVALID_OPTIONS","created/expires must be integers.");if(R.expires<=R.created)throw new J("INVALID_OPTIONS","expires must be > created.");if(!R.keyid)throw new J("INVALID_OPTIONS","keyid is required.")}function Lf(R,f){return B(R),`${R}=${f}`}function Af(R,f){if(B(R),!/^[A-Za-z0-9+/]+={0,2}$/.test(f))throw new J("BAD_HEADER_VALUE","Signature must be base64.");return`${R}=:${f}:`}function ff(R,f){if(!R)return f;return`${R}, ${f}`}function T(R){for(let I=0;I<R.length;I++){let K=R.charCodeAt(I);if(K>=0&&K<=31||K===127)throw new J("BAD_HEADER_VALUE","sf-string cannot contain control characters.")}return`"${R.replace(/\\/g,"\\\\").replace(/"/g,"\\\"")}"`}function Of(R){return R.map((f)=>f.trim()).filter(Boolean)}function rf(R){let{binding:f,hasQuery:I,hasBody:K}=R;if(f==="class-bound")return["@authority"];let $=["@authority","@method","@path"];if(I)$.push("@query");if(K)$.push("content-digest");return $}function qf(R){let{binding:f,hasQuery:I,hasBody:K,providedComponents:$}=R;if(f==="request-bound"){let Y=rf({binding:f,hasQuery:I,hasBody:K});if(!$)return Y;let Z=Of($).filter((G)=>!Y.includes(G));return Y.concat(Z)}if(!$)throw new J("INVALID_OPTIONS","components are required for class-bound signatures.");let C=Of($);if(!C.includes("@authority"))C.unshift("@authority");return C}function u(R){let{request:f,components:I,signatureParamsValue:K}=R,$=L(f.url),C=[];for(let G of I){let N=sf({request:f,url:$,component:G});if(/[^\x20-\x7E]/.test(N)||N.includes("\r")||N.includes(`
`))throw new J("BAD_DERIVED_VALUE",`Component ${G} produced invalid characters.`);C.push(`${T(G)}: ${N}`)}let Y=`${T("@signature-params")}: ${K}`,Z=C.length?`${C.join(`
`)}
${Y}`:Y;return jf(Z)}function sf(R){let{request:f,url:I,component:K}=R;switch(K){case"@method":{let $=(f.method||"GET").toUpperCase();return y($,"@method"),$}case"@authority":{let $=I.protocol.replace(":","").toLowerCase(),C=I.hostname.toLowerCase(),Y=I.port,Z=C;if(Y){let G=Number(Y);if(!($==="http"&&G===80||$==="https"&&G===443))Z=`${C}:${Y}`}return y(Z,"@authority"),Z}case"@path":{let $=I.pathname||"/";return y($,"@path"),$}case"@query":{let $=I.search||"";return y($,"@query"),$}default:{let $=f.headers.get(K);if($==null)throw new J("BAD_HEADER_VALUE",`Required header "${K}" is missing.`);let C=af($);return y(C,K),C}}}function af(R){return R.trim().replace(/[ \t]+/g," ")}function y(R,f){if(R.includes("\r")||R.includes(`
`))throw new J("BAD_DERIVED_VALUE",`${f} contains CR/LF.`)}function Rf(R,f){if(!Number.isInteger(R))throw new J("INVALID_OPTIONS","chainId must be positive integer.");return`erc8128:${R}:${f.toLowerCase()}`}function If(R){let f=/^erc8128:(\d+):(0x[a-fA-F0-9]{40})$/.exec(R);if(!f)return null;let I=Number(f[1]);if(!Number.isInteger(I))return null;return{chainId:I,address:f[2].toLowerCase()}}async function Pf(R){if(typeof R.nonce==="string")return R.nonce;if(typeof R.nonce==="function")return R.nonce();let f=Mf(16);return Wf(f)}async function c(R,f,I,K){let $,C,Y;if(l(f))C=f,Y=I;else $=f,C=I,Y=K;let Z=Y??{},G=Df(R,$),N=Z.label??"eth",V=Z.binding??"request-bound",z=Z.replay??"non-replayable",Q=Z.contentDigest??"auto",k=p(),W=Z.created??k,X=Z.ttlSeconds??60,D=Z.expires??W+X,_=z==="non-replayable"?await Pf(Z):void 0,v=Rf(C.chainId,C.address),Zf=L(G.url).search.length>0,q=G.body!=null,O=qf({binding:V,hasQuery:Zf,hasBody:q,providedComponents:Z.components}),F=G;if(O.includes("content-digest"))F=await e(F,Q);else if(V==="request-bound"&&q)O=[...O,"content-digest"],F=await e(F,Q);let E={created:W,expires:D,keyid:v,..._?{nonce:_}:{}};xf(E);let U=Hf(O,E),b=Lf(N,U),j=u({request:F,components:O,signatureParamsValue:U}),x=await C.signMessage(j),m=wf(x);if(m.length===0)throw new J("UNSUPPORTED_REQUEST","Signer returned empty signature.");let P=A(m),M=Af(N,P),H=new Headers(F.headers);return H.set("Signature-Input",ff(H.get("Signature-Input"),b)),H.set("Signature",ff(H.get("Signature"),M)),new Request(F,{headers:H})}async function n(R,f,I,K){let $,C,Y;if(l(f))C=f,Y=I;else $=f,C=I,Y=K;let Z=await c(R,$,C,Y),G=Y?.fetch??globalThis.fetch;if(typeof G!=="function")throw new J("UNSUPPORTED_REQUEST","No fetch implementation available. Provide opts.fetch.");return G(Z)}var ef=new Set(["method","headers","body","signal","credentials","mode","cache","redirect","referrer","integrity","keepalive","window"]);function fR(R){if(!R||typeof R!=="object")return!1;for(let f of ef)if(f in R)return!0;return!1}function $f(R,f){if(f!==void 0)return{init:R,opts:f};if(fR(R))return{init:R};return{opts:R}}function RR(R,f){let I=f??{};return{signRequest:async(Y,Z,G)=>{let{init:N,opts:V}=$f(Z,G),z={...I,...V};return c(Y,N,R,z)},signedFetch:async(Y,Z,G)=>{let{init:N,opts:V}=$f(Z,G),z={...I,...V};return n(Y,N,R,z)},fetch:async(Y,Z,G)=>{let{init:N,opts:V}=$f(Z,G),z={...I,...V};return n(Y,N,R,z)}}}function IR(R,f){let K=`(${R.map(($)=>T($)).join(" ")})`;if(K+=";keyid;created;expires",f)K+=";nonce";return K}function hf(R){let{requestBoundRequired:f,classBoundPolicies:I,requireNonce:K}=R,$=[],C=new Set,Y=1,Z=(G)=>{let N=G.join("\x00");if(C.has(N))return;C.add(N);let V=IR(G,K);$.push(`sig${Y}=${V}`),Y++};Z(f);for(let G of I)Z(G);return $.join(", ")}function Sf(R){let{signatureInputHeader:f,signatureHeader:I,policy:K}=R,$=K.label,C=K.strictLabel??!1;try{let Y=Tf(f),Z=kf(I),G=[];for(let N of Y){let V=Z.get(N.label);if(!V)continue;G.push({label:N.label,components:N.components,params:N.params,signatureParamsValue:N.signatureParamsValue,sigB64:V})}if(G.length===0)return{ok:!1,result:{ok:!1,reason:"label_not_found"}};if($!=null&&C){let N=G.filter((V)=>V.label===$);if(N.length===0)return{ok:!1,result:{ok:!1,reason:"label_not_found"}};return{ok:!0,selected:N}}return{ok:!0,selected:G}}catch(Y){let Z=Y instanceof Error?Y.message:"Failed to parse signature headers.";if(Y instanceof J&&Y.code==="PARSE_ERROR")return{ok:!1,result:{ok:!1,reason:"bad_signature_input",detail:Z}};return{ok:!1,result:{ok:!1,reason:"bad_signature_input",detail:Z}}}}function Bf(R,f,I){let K=Kf(f,I);return Cf(K,R)}function Kf(R,f){let I=["@authority","@method","@path"];if(R.hasQuery)I.push("@query");if(R.hasBody)I.push("content-digest");if(f)for(let K of f){let $=K.trim();if(!$)continue;if(!I.includes($))I.push($)}return I}function Cf(R,f){let I=new Set(f);for(let K of R)if(!I.has(K))return!1;return!0}function d(R){if(!R)return[];let f=[],I=new Set;for(let K of R){let $=K.trim();if(!$||I.has($))continue;I.add($),f.push($)}return f}function yf(R){if(!R||R.length===0)return[];if(typeof R[0]==="string")return[d(R)];return R.map((f)=>d(f))}function vf(R){if(R.includes("@authority"))return R;return["@authority",...R]}var $R=300;function gf(R,f){let{hasQuery:I,hasBody:K,requestBoundExtras:$,requestBoundRequired:C,classBoundPolicies:Y}=f,Z=[],G=!1;for(let N of R){let{candidate:V}=N;if(Bf(V.components,{hasQuery:I,hasBody:K},$)){Z.push({candidate:N,kind:"request-bound",policyLength:C.length});continue}if(G=!0,Y.length===0)continue;let Q=Y.filter((W)=>Cf(W,V.components));if(Q.length===0)continue;let k=Math.min(...Q.map((W)=>W.length));Z.push({candidate:N,kind:"class-bound",policyLength:k})}return{attempts:Z,sawClassBound:G}}function Ef(R){let{now:f,skew:I,maxValiditySec:K,created:$,expires:C}=R;if(typeof $!=="number"||typeof C!=="number"||!Number.isInteger($)||!Number.isInteger(C)||C<=$)return{ok:!1,reason:"bad_time"};let Y=$,Z=C;if(f+I<Y)return{ok:!1,reason:"not_yet_valid"};if(f-I>Z)return{ok:!1,reason:"expired"};let G=typeof K==="number"&&Number.isFinite(K)?K:$R;if(Z-Y>G)return{ok:!1,reason:"validity_too_long"};return null}function bf(R){let{allowReplayable:f,params:I,now:K,nonceStore:$,nonceKey:C,maxNonceWindowSec:Y}=R,Z=typeof I.nonce==="string"&&I.nonce.length>0;if(!Z&&!f)return{failure:{ok:!1,reason:"replayable_not_allowed"},plan:{replayKey:null,replayStore:null,replayTtlSeconds:0}};if(Z){if(!$)return{failure:{ok:!1,reason:"nonce_required",detail:"nonceStore missing"},plan:{replayKey:null,replayStore:null,replayTtlSeconds:0}};if(Y!=null&&typeof I.created==="number"&&typeof I.expires==="number"&&I.expires-I.created>Y)return{failure:{ok:!1,reason:"nonce_window_too_long"},plan:{replayKey:null,replayStore:null,replayTtlSeconds:0}};let G=I.nonce;if(!G)return{failure:{ok:!1,reason:"nonce_required",detail:"nonce missing"},plan:{replayKey:null,replayStore:null,replayTtlSeconds:0}};return{failure:null,plan:{replayKey:(C??((V,z)=>`${V}:${z}`))(I.keyid,G),replayStore:$,replayTtlSeconds:Math.max(0,(I.expires??K)-K)}}}return{failure:null,plan:{replayKey:null,replayStore:null,replayTtlSeconds:0}}}function mf(R){let{request:f,components:I,signatureParamsValue:K}=R;return u({request:f,components:I,signatureParamsValue:K})}var KR=3;async function Yf(R,f,I,K,$){let C={...K,verifyMessage:f,nonceStore:I},Y=C.label,Z=C.strictLabel??!1,G=C.now?.()??p(),N=C.clockSkewSec??0,V=C.replayable??!1,Q=L(R.url).search.length>0,k=R.body!=null,W=d(C.additionalRequestBoundComponents),X=Kf({hasQuery:Q,hasBody:k},W),D=yf(C.classBoundPolicies).map((j)=>vf(j));if($)try{let j=hf({requestBoundRequired:X,classBoundPolicies:D,requireNonce:!V});$("Accept-Signature",j)}catch{}let _=R.headers.get("Signature-Input"),v=R.headers.get("Signature");if(!_||!v)return{ok:!1,reason:"missing_headers"};let g=Sf({signatureInputHeader:_,signatureHeader:v,policy:{label:Y,strictLabel:Z}});if(!g.ok)return g.result;let q=g.selected.map((j)=>{let x=If(j.params.keyid);if(!x)return null;return{candidate:j,key:x}}).filter((j)=>j!=null);if(q.length===0)return{ok:!1,reason:"bad_keyid"};let{attempts:O,sawClassBound:F}=gf(q,{hasQuery:Q,hasBody:k,requestBoundExtras:W,requestBoundRequired:X,classBoundPolicies:D});if(O.length===0){if(F&&D.length>0)return{ok:!1,reason:"class_bound_not_allowed"};return{ok:!1,reason:"not_request_bound"}}let E=typeof C.maxSignatureVerifications==="number"&&Number.isFinite(C.maxSignatureVerifications)&&C.maxSignatureVerifications>0?Math.floor(C.maxSignatureVerifications):KR,U={ok:!1,reason:"bad_signature"},b=0;for(let j of O){if(b>=E)break;b++;let{candidate:x,key:m}=j.candidate,{components:P,params:M,signatureParamsValue:H,sigB64:pf,label:Gf}=x,{chainId:uf,address:Jf}=m,t=!M.nonce||M.nonce.length===0,Nf=Ef({now:G,skew:N,maxValiditySec:C.maxValiditySec,created:M.created,expires:M.expires});if(Nf){U=Nf;continue}let{failure:Vf,plan:h}=bf({allowReplayable:V,params:M,now:G,nonceStore:C.nonceStore,nonceKey:C.nonceKey,maxNonceWindowSec:C.maxNonceWindowSec});if(Vf){U=Vf;continue}if(t){if(!(typeof C.replayableNotBefore==="function"||typeof C.replayableInvalidated==="function")){U={ok:!1,reason:"replayable_invalidation_required"};continue}if(typeof C.replayableNotBefore==="function"){let S=await C.replayableNotBefore(M.keyid);if(typeof S==="number"&&Number.isFinite(S)&&M.created<S){U={ok:!1,reason:"replayable_not_before"};continue}}}if(P.includes("content-digest")){if(!R.headers.get("content-digest")){U={ok:!1,reason:"digest_required"};continue}if(!await Ff(R)){U={ok:!1,reason:"digest_mismatch"};continue}}let Xf=mf({request:R,components:P,signatureParamsValue:H}),o=Qf(pf);if(!o||o.length===0){U={ok:!1,reason:"bad_signature_bytes"};continue}let zf=a(o);if(t&&typeof C.replayableInvalidated==="function"){if(await C.replayableInvalidated({keyid:M.keyid,created:M.created,expires:M.expires,label:Gf,signature:zf,signatureBase:Xf,signatureParamsValue:H})){U={ok:!1,reason:"replayable_invalidated"};continue}}let Uf=C.verifyMessage;if(!Uf){U={ok:!1,reason:"bad_signature_check",detail:"verifyMessage missing in policy"};continue}try{if(await Uf({address:Jf,message:{raw:a(Xf)},signature:zf})){if(h.replayKey&&h.replayStore){if(!await h.replayStore.consume(h.replayKey,h.replayTtlSeconds)){U={ok:!1,reason:"replay"};continue}}return{ok:!0,address:Jf,chainId:uf,label:Gf,components:P,params:M,replayable:t,binding:j.kind}}}catch{U={ok:!1,reason:"bad_signature_check"};continue}U={ok:!1,reason:"bad_signature"}}return U}function CR(R,f,I){let K=I??{};return{verifyRequest:async(C,Y,Z)=>{let G={...K,...Y};return Yf(C,R,f,G,Z)}}}export{Yf as verifyRequest,n as signedFetch,c as signRequest,If as parseKeyId,Rf as formatKeyId,CR as createVerifierClient,RR as createSignerClient,J as Erc8128Error};
